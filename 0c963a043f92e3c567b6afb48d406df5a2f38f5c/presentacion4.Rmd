---
title: "Taller Introductorio al uso de R Studio- Clase 4"
output:
  ioslides_presentation:
    autosize: true
    transition: slower
    logo: logo.png
    code_folding: hide
    toc_float: TRUE 
---

<style>
.superbigimage{
    overflow-y:scroll;
    white-space: nowrap;
}
.superbigimage img{
    overflow-y: scroll;
    overflow-x: hidden;
}
.p {
  text-align: right;
}
.reveal section p {
    font-size: 0.5em;
}
.reveal .slides section .slideContent ui li{
    font-size: 0.6em;
    color: red;
}
.reveal section pre code {
    font-size: 0.6em;
}
.future-steps {
  color: MidnightBlue;
}
.otro {
  color: Teal;
}
.Advertencia {
  color: Crimson;
}
code.r{
  font-size: 3px;
}
pre {
  white-space: pre !important;
  overflow-y: scroll !important;
  max-height: 10vh !important;
  font-size: 1px;
}
.small-code pre code {
  font-size: 0.8em;
}
.codefont pre {
    font-size: 2px;
    line-height: 1px;
}
.gdbar img {
    width: 500px !important;
    height: 150px !important;
    margin: 10px 10px;
}
.gdbar {
    width: 550px !important;
    height: 175px !important;
}
slides > slide:not(.nobackground):before {
    right: 0px;    
    width: 200px;
    height: 70px;
    background-size: 1px 1px;
    padding: 0px 0;
}
.forceBreak { -webkit-column-break-after: always; break-after: column; }
slides > slide {
  overflow-x: auto !important;
  overflow-y: auto !important;
}
</style>
<script>
slides > slide:not(.nobackground):before {
  background: none;
}
</script>


```{r setup, include=T}
knitr::opts_chunk$set(echo = FALSE)
if(!require(dplyr)){install.packages("dplyr")}
if(!require(readxl)){install.packages("readxl")}
if(!require(ggplot2)){install.packages("ggplot2")}
if(!require(tidyr)){install.packages("tidyr")}
if(!require(plotly)){install.packages("plotly")}
if(!require(sjPlot)){install.packages("sjPlot")}
if(!require(lmtest)){install.packages("lmtest")}
if(!require(plm)){install.packages("plm")}
if(!require(broom)){install.packages("broom")}
if(!require(kableExtra)){install.packages("kableExtra")}
if(!require(knitr)){install.packages("knitr")}
```

## Contenidos{.future-steps}

```{r, echo=FALSE}
unlink('0c963a043f92e3c567b6afb48d406df5a2f38f5c/presentacion4_cache', recursive = TRUE)
htmltools::img(src = knitr::image_uri(gsub("0c963a043f92e3c567b6afb48d406df5a2f38f5c/","",paste0(getwd(),"/","logo.png"))), 
               alt = 'logo', 
               style = 'opacity: 0.8;position:fixed; top:100%;right:100%')
```

- **Configuración de datos**
- **EXTRA: ggplot2**

## dplyr y ggplot {.future-steps .smaller}

- TIDYVERSE(DPLYR):
  - Manipulación de datos. Similitud a PANDAS (Python)
  - Flujo de trabajo
  - Permite mayor simplicidad en la codificación
  - Concatenación (pipe)
  - Sintaxis entendible
  - Similar a manipulación vía SQL
  - Desventaja: mucho uso de memoria.
- GGPLOT:
  - Gramática de los gráficos por capas (<http://vita.had.co.nz/papers/layered-grammar.pdf>)
  - Permite seguir los pasos y los distintos componentes del gráfico
  - Permite una fácil forma de iteración para distintos gráficos

```{r Fig badges, fig.align="center", message=FALSE, warning=FALSE, cache=T, echo =F, out.width = "500x"}
#knitr::include_graphics("G:/Mi unidad/Alvacast/Curso/Importar_xlsx.png")
knitr::include_graphics(paste0(getwd(),"/rstudioconf_ohi_hex.jpg"))
```

::: notes
https://cursor2020.shinyapps.io/Curso/
::: 

## Ejemplo integración {.future-steps .smaller}

Procesos: bajar base de datos (1), seleccionar columnas (`dplyr::select`) (2), formatear fecha (desde formato de texto día-mes-año a "Ymd") (3), filtrar regiones (sólo Tarapacá, Antofagasta y Atacama) (4), generar figura de serie de datos (Fecha como eje X y Nuevo Caso Confirmado como eje Y), discriminando por Región por colores (5), generamos un área gris del rango intercuartil del resto de regiones, excluyendo a la región metropolitana (al 80% o `fill=grey70`) con transparencia para que no se superponga (`alpha=.4`) (6), definimos los colores de las líneas: rojo para Antofagasta, verde para Atacama, azul para Tarapacá y negro para la mediana del resto de regiones (`scale_color_manual`) (7).

```{r ejemplo_a, echo=T, warning=F, size = 'tiny'}
covid19_chile_ant_ata_tar <- 
    readr::read_csv("https://raw.githubusercontent.com/ivanMSC/COVID19_Chile/master/covid19_chile.csv") %>% 
    dplyr::select(Fecha, Region, `Nuevo Confirmado`) %>%
    dplyr::mutate(Fecha=as.Date.character(Fecha,tryFormats = "%d-%m-%Y")) %>% 
    dplyr::filter(Region %in% c("Tarapacá","Antofagasta","Atacama")) %>% 
    ggplot()+
      geom_line(aes(x=as.Date(Fecha), y=`Nuevo Confirmado`, color=Region))+
      scale_x_date()+
      xlab("Fecha")+
      sjPlot::theme_blank()+
      theme(legend.position="bottom")

covid19_chile_resto <-
    readr::read_csv("https://raw.githubusercontent.com/ivanMSC/COVID19_Chile/master/covid19_chile.csv") %>% 
    dplyr::select(Fecha, Region, `Nuevo Confirmado`) %>%
    dplyr::mutate(Fecha=as.Date.character(Fecha,tryFormats = "%d-%m-%Y")) %>% 
    dplyr::filter(!Region %in% c("Tarapacá","Antofagasta","Atacama")) %>% 
    dplyr::filter(!Region %in% c("Metropolitana")) %>% 
    dplyr::group_by(Fecha)%>% 
    dplyr::summarise(mdn=median(`Nuevo Confirmado`,na.rm=T),
                     q1=quantile(`Nuevo Confirmado`,.25,na.rm=T),
                     q3=quantile(`Nuevo Confirmado`,.75,na.rm=T))

covid19_chile_ant_ata_tar+ 
    geom_ribbon(data= covid19_chile_resto, aes(y= mdn, x= Fecha, ymin = q1, ymax = q3), fill = "grey70", color="grey70", alpha=.4)+
    geom_line(data= covid19_chile_resto, aes(x= Fecha, y= mdn, color="black"))+
    scale_color_manual(name= "Región", values = c("red","green","blue","black"), 
                       label=c("Antofagasta","Atacama","Tarapacá","Mediana (resto regiones\nexcluyendo Metropolitana)"))
```

- ¿No se ve más ordenado?, lo valorarán cuando trabajen con condiciones anidadas (IFs concatenados)

```{r Fig pipe_vs_rest, fig.align="center", message=FALSE, warning=FALSE, cache=T, echo =F, out.width = "500x"}
#knitr::include_graphics("G:/Mi unidad/Alvacast/Curso/Ejercicio15.png")
knitr::include_graphics(
  #gsub("0c963a043f92e3c567b6afb48d406df5a2f38f5c/","",
       paste0(getwd(),"/","pipe_vs_rest.png")
  )
```


## Otra forma de escribirlo {.future-steps .smaller}

Factorizamos lo que tienen en común las bases de datos, y para cada capa filtramos los datos de interés.

```{r ejemplo_b, echo=T, warning=F, size = 'tiny'}
covid19_chile <-
    readr::read_csv("https://raw.githubusercontent.com/ivanMSC/COVID19_Chile/master/covid19_chile.csv") %>% 
    dplyr::select(Fecha, Region, `Nuevo Confirmado`) %>%
    dplyr::mutate(Fecha=as.Date.character(Fecha,tryFormats = "%d-%m-%Y"))

ggplot()+
      geom_line(data=covid19_chile %>% 
                  dplyr::filter(Region %in% c("Tarapacá","Antofagasta","Atacama")),
                aes(x=as.Date(Fecha), y=`Nuevo Confirmado`, color=Region))+
      scale_x_date()+
      xlab("Fecha")+
      sjPlot::theme_blank()+
      theme(legend.position="bottom")+
      geom_ribbon(data= covid19_chile %>% 
                  dplyr::filter(!Region %in% c("Tarapacá","Antofagasta","Atacama","Metropolitana")) %>% 
                  dplyr::group_by(Fecha)%>% 
                  dplyr::summarise(mdn=median(`Nuevo Confirmado`,na.rm=T),
                     q1=quantile(`Nuevo Confirmado`,.25,na.rm=T),
                     q3=quantile(`Nuevo Confirmado`,.75,na.rm=T)), 
                aes(y= mdn, x= Fecha, ymin = q1, ymax = q3), fill = "grey70", color="grey70", alpha=.4)+
    geom_line(data= covid19_chile_resto, aes(x= Fecha, y= mdn,color="black"))+
    scale_color_manual(name= "Región", values = c("red","green","blue","black"), 
                       label=c("Antofagasta","Atacama","Tarapacá","Mediana (resto regiones\nexcluyendo Metropolitana)"))
```

## Facet Wrap por Región {.future-steps .smaller}

Muy complejo y todo, pero no entendí nada los gráficos anteriores. Si queremos separar los datos por región:

```{r ejemplo_c, echo=T, warning=F, size = 'tiny'}
ggplot()+
      geom_line(data=covid19_chile %>% 
                  dplyr::filter(Region %in% c("Tarapacá","Antofagasta","Atacama")),
                aes(x=as.Date(Fecha), y=`Nuevo Confirmado`, color=Region))+
        geom_ribbon(data= covid19_chile %>% 
                  dplyr::filter(!Region %in% c("Tarapacá","Antofagasta","Atacama","Metropolitana")) %>% 
                  dplyr::group_by(Fecha)%>% 
                  dplyr::summarise(mdn=median(`Nuevo Confirmado`,na.rm=T),
                     q1=quantile(`Nuevo Confirmado`,.25,na.rm=T),
                     q3=quantile(`Nuevo Confirmado`,.75,na.rm=T)), 
                aes(y= mdn, x= Fecha, ymin = q1, ymax = q3), fill = "grey70", color="grey70", alpha=.4)+
      scale_x_date()+
      xlab("Fecha")+
      sjPlot::theme_blank()+
      theme(legend.position="bottom")+
      facet_wrap(~Region, ncol = 1)
```


## Ejercicio

- Ocupe la misma base de datos.
- Seleccione las muertes diarias notificadas (`Nuevo Muerte`)
- Haga un gráfico con Valparaíso en comparación a la mediana y el rango intercuartil de los conteos diarios del resto de las regiones en conjunto.

```{r ej1, echo=T, warning=F, size = 'tiny', include=F}

covid19_chile_muertes <-
    readr::read_csv("https://raw.githubusercontent.com/ivanMSC/COVID19_Chile/master/covid19_chile.csv") %>% 
    dplyr::select(Fecha, Region, `Nuevo Muerte`) %>%
    dplyr::mutate(Fecha=as.Date.character(Fecha,tryFormats = "%d-%m-%Y"))

ggplot()+
      geom_line(data=covid19_chile_muertes %>% 
                  dplyr::filter(Region %in% c("Valparaíso")),
                aes(x=as.Date(Fecha), y=`Nuevo Muerte`, color=Region))+
        geom_ribbon(data= covid19_chile_muertes %>% 
                  dplyr::filter(!Region %in% c("Valparaíso")) %>% 
                  dplyr::group_by(Fecha)%>% 
                  dplyr::summarise(mdn=median(`Nuevo Muerte`,na.rm=T),
                     q1=quantile(`Nuevo Muerte`,.25,na.rm=T),
                     q3=quantile(`Nuevo Muerte`,.75,na.rm=T)), 
                aes(y= mdn, x= Fecha, ymin = q1, ymax = q3), fill = "grey70", color="grey70", alpha=.4)+
      scale_x_date()+
      xlab("Fecha")+
      sjPlot::theme_blank()+
      theme(legend.position="bottom")+
      facet_wrap(~Region, ncol = 1)+
  labs(caption= "Nota. Área gris, Rango intercuartil del Resto de las regiones")
```

- Nótese la calidad de los datos provistos (ej., 2020-06-08, ¿el 50% obtuvo menos 1,5 muertes?)

## Vacunaciones COVID-19(1) {.future-steps .smaller}

- Existen antecedentes de que gran parte de las parejas en Coquimbo aumentaron su exposición. El resto, recurrió a otros medios de contacto
- Esto no ocurrió en regiones, quienes se encontraban en cuarentena estricta
- Dado que algunos expertos señalan que la transmisibilidad se reduce con la primera dosis, mayores vacunaciones debiesen confundir las asociaciones 
- **¿El 14 de febrero en Coquimbo tuvo un efecto en el aumento de casos (controlando por vacunaciones)?**
- Debemos incorporar las vacunaciones a la base de datos de nuevos casos
- Otro paquete de la familia Tidyverse es "tidyr"
- Similar a las funciones utilizadas por `reshape` (cambiar el formato largo y ancho de los datos)
- También mostraremos como ejemplo los `join`.
- Permiten combinar bases de datos
  - Left
  - Inner
  - Right
  - Otros (ej., probabilístico)

## Vacunaciones COVID-19(2) {.future-steps .smaller}
- Se estandarizaron las variables de acuerdo a la población de la región, por cada 100,000 hab.
- Se generó un modelo de efectos fijos para capturar eventuales cambios en coquimbo en comparación a otras regiones a partir del 14 de febrero
- ¿Fue la forma correcta de incorporar las bases de datos? ¿Se perdió información?

```{r ejemplo_d, echo=T, warning=F, size = 'tiny'}
library(tidyr)
library(lmtest)
library(plm)
library(broom)
library(kableExtra)
covid19_chile_vacuna_vs_confirmados <-
    readr::read_csv("https://raw.githubusercontent.com/MinCiencia/Datos-COVID19/master/output/producto76/vacunacion.csv") %>%
  #Formato largo de fechas
    tidyr::pivot_longer(cols=starts_with("20"), names_to="fecha", values_to="recuento") %>% 
  #Formato ancho por tipo de dosis (diferenciando primera y segunda en columnas distintas)
    tidyr::pivot_wider(names_from=starts_with("Dosis"), values_from="recuento") %>% 
    dplyr::mutate(fecha=as.Date.character(fecha,tryFormats = "%Y-%m-%d")) %>% 
  # Unir con la base de datos de casos por Región
    dplyr::left_join(covid19_chile, by=c("fecha"="Fecha", "Region"="Region")) %>% 
    dplyr::filter(Region!="Total") %>% 
    dplyr::select(-Segunda) %>% 
    dplyr::filter(!is.na(Primera)) %>% 
    dplyr::mutate(met=factor(ifelse(Region=="Coquimbo",1,0))) %>% 
    dplyr::mutate(txtime=factor(ifelse(fecha>="2021-02-14",1,0))) %>% 
    dplyr::rename("conf"="Nuevo Confirmado")

#Base de datos de PCR's y UCI's
covid19_chile_vacuna_vs_confirmados %>%     
  dplyr::left_join(readr::read_csv("https://raw.githubusercontent.com/MinCiencia/Datos-COVID19/master/output/producto7/PCR_std.csv"), 
                   #Los criterios para parear es la Región(i) y la fecha(t) 
                   by=c("Region", "fecha")) %>% 
  dplyr::left_join(readr::read_csv("https://raw.githubusercontent.com/MinCiencia/Datos-COVID19/master/output/producto8/UCI_std.csv") %>% 
                     #sacar variables redundantes: código de región, población y número
                     dplyr::select(-`Codigo region`,-Poblacion), 
                   by=c("Region", "fecha")) %>% 
  dplyr::mutate(conf_100mil=(conf/Poblacion)*100000) %>% 
  dplyr::mutate(Primera_100mil= (Primera/Poblacion)*100000) %>% 
  dplyr::mutate(PCR_100mil= (numero.x/Poblacion)*100000) %>% 
  dplyr::mutate(Hosp_UCI_100mil= (numero.y/Poblacion)*100000) %>% 
  as.data.frame() %>% 
  #Para definir la base de datos
  assign("covid19_chile_vacuna_vs_confirmados_std_pcr_uci",., envir=.GlobalEnv)

paste0("La fecha mínima pareada fue ",min(covid19_chile_vacuna_vs_confirmados_std_pcr_uci$fecha),";\n", "La máxima fecha disponible fue ",max(covid19_chile_vacuna_vs_confirmados_std_pcr_uci$fecha))    

# Modelo de efectos fijos
did.reg <- plm(conf_100mil ~ txtime + met + txtime:met + Primera_100mil + PCR_100mil + Hosp_UCI_100mil, 
               data = covid19_chile_vacuna_vs_confirmados_std_pcr_uci,  index=c("Region", "fecha"), model = "within")

parameters::model_parameters(did.reg) %>% 
  data.frame() %>% 
  #Cambiamos los nombres de las variables
  dplyr::mutate(Parameter= dplyr::case_when(Parameter=="txtime1"~"14 de Febrero hasta el día de obtención",
                                       Parameter=="Primera_100mil"~"Primera dosis por cada 100 mil hab.",
                                       Parameter=="PCR_100mil"~"PCR's por cada 100 mil hab.",
                                       Parameter=="Hosp_UCI_100mil"~"Hospitalizaciones por cada 100 mil hab.",
                                       Parameter=="txtime1:met1"~"Coquimbo x 14 de Febrero"
                                       )) %>% 
  dplyr::mutate_at(vars("Coefficient","SE","CI_low", "CI_high","t", "df_error"), funs(round(.,2))) %>% 
  #Aproximamos a 3, de manera que los interesados puedan ver el valor p con 3 decimales
  dplyr::mutate_at(vars("p"), funs(round(.,3))) %>% 
  dplyr::mutate(p=ifelse(p<0.001,"<0.001",as.character(p))) %>% 
  dplyr::mutate(CI_95=paste0(sprintf("%3.2f", CI_low),", ", sprintf("%3.2f", CI_high))) %>% 
  dplyr::select(-CI_low, -CI_high, -df_error) %>% 
  #generar tabla en formato html, definiendo título y nombre de columnas
  knitr::kable(.,format = "html", format.args = list(decimal.mark = ".", big.mark = ","),
               caption = paste0("Tabla 1. Coeficientes Diferencia en Diferencias"),
               col.names = c("Variables Independientes","Coeficiente","Error Estándar","Estadístico t", "Sig", "IC 95%"),
align =c('l',rep('c', 101)))%>%
  #destaca la quinta fila correspondiente a la intervención para el tratado
  kableExtra::row_spec(5,bold=T,hline_after = T) %>% 
    kableExtra::add_footnote(c("Nota. IC 95%= Intervalos de Confianza al 95%"), notation = "none")%>%
  kableExtra::kable_styling(bootstrap_options = c("striped", "hover"),font_size = 13)
```
<br>

```{r pred_se, echo=T, cache= T, paged.print=TRUE, warning=F, eval=T, fig.align='center'}
se <- function(x) sqrt(var(x)/length(x))

Produc_means <- covid19_chile_vacuna_vs_confirmados_std_pcr_uci %>% 
  dplyr::group_by(Region) %>% 
  transmute(y_median = median(conf_100mil),
            y = conf_100mil, 
            fecha = fecha) %>% 
  dplyr::ungroup() %>% 
  dplyr::mutate(y_pred = predict(did.reg) + y_median) %>% 
  dplyr::select(-y_median)

#OTRA FORMA DE ESTIMAR LOS PREDICTORES
#https://stackoverflow.com/questions/28547614/prediction-with-plm-method
pmodel_fixed <-pmodel.response(did.reg,model='fixed') 


Produc_means %>% 
  gather(type, value, y, y_pred) %>% 
  dplyr::mutate(coquimbo=ifelse(Region=="Coquimbo",1,0)) %>% 
  dplyr::group_by(coquimbo,type,fecha) %>% 
  dplyr::mutate(median=median(value), se=se(value)) %>%
  dplyr::ungroup() %>% 
  dplyr::filter(Region %in% c("Arica y Parinacota", "Coquimbo")) %>% 
  ggplot(aes(x = fecha, y = median, linetype = type))+
  geom_line() +
  geom_ribbon(aes(y= median, x= fecha, ymin = median-se, ymax = median+se), fill = "grey70", color="grey70", alpha=.4)+
  scale_linetype_manual(name="Valores",values=c("solid","dashed"), labels=c("Actual", "Estimado"))+
  facet_wrap(~coquimbo, labeller=as_labeller(c(`0` = "Otras Regiones", `1` = "Coquimbo")))+
  geom_vline(xintercept = as.Date("2021-02-14"),linetype="longdash")+
  theme_blank()+
  ggtitle("Prediciones y Medianas por fecha de nuevos casos confirmados")+
  labs(caption="Nota. Área gris representa el error estandar por región;\nLínea vertical= 14 de Febrero")
```


## Vacunaciones COVID-19(3)-Limitaciones {.future-steps .smaller}
- A partir del gráfico no es tan claro distinguir si las diferencias se deben al 14 de febrero
- Las covariables podrían verse afectadas por la intervención (14 feb)
- Adicionalmente, la capacidad de predicción del modelo se aprecia baja
- La diferencia en cada punto de tiempo no es constante en el periodo pre-intervención
- Sólo un tratado
- Igual no son del todo comparables las series (ausencia soporte común)
- Hay patrones temporales que no son capturados (ciclos, tendencias, estaciones, retrasos)
- Las primeras vacunas siguen un patrón muy distinto

```{r ejemplo_d2, echo=T, warning=F, size = 'tiny'}
mean_cl_quantile <- function(x, q = c(0.025, 0.975), na.rm = TRUE){
  dat <- data.frame(y = mean(x, na.rm = na.rm),
                    ymin = quantile(x, probs = q[1], na.rm = na.rm),
                    ymax = quantile(x, probs = q[2], na.rm = na.rm))
  return(dat)
}

ggplot(covid19_chile_vacuna_vs_confirmados_std_pcr_uci, aes(fecha, conf_100mil, color = met)) +
    stat_summary(geom = 'line', fun.y = median) +
    stat_summary(geom = "ribbon", fun.data = mean_cl_quantile, alpha = 0.3, fill="red")+
    geom_vline(xintercept = as.Date("2021-02-14")) +
    scale_color_manual(name="Grupo",labels = c("Otras\nRegiones", "Coquimbo"), values=c("red","blue"))+
    sjPlot::theme_sjplot2()+
  labs(caption="Nota. Área roja: intervalos de confianza al 95%;\nLínea vertical: 14 de febrero 2021")
```

```{r cache_delete, include=F}
#unlink('*_files', recursive = T, force=T)
unlink("*_cache", recursive = T, force= T)
```
